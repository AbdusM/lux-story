/**
 * Vulnerability Arcs Tests
 *
 * Tests for E2-061 to E2-065: Character vulnerability reveals
 * - E2-062: Samuel's Vulnerability - "What he lost to become the Conductor"
 * - E2-063: Marcus's Vulnerability - "The breach he couldn't prevent"
 * - E2-064: Kai's Vulnerability - "The project that failed inspection"
 * - E2-065: Rohan's Vulnerability - "The truth that cost him relationships"
 */

import { describe, test, expect } from 'vitest'
import { VULNERABILITY_TRUST_THRESHOLD, TRUST_THRESHOLDS } from '../../lib/constants'
import { DialogueNode } from '../../lib/dialogue-graph'
import { samuelDialogueNodes } from '../../content/samuel-dialogue-graph'
import { marcusDialogueNodes } from '../../content/marcus-dialogue-graph'
import { kaiDialogueNodes } from '../../content/kai-dialogue-graph'
import { rohanDialogueNodes } from '../../content/rohan-dialogue-graph'
import { mayaDialogueNodes } from '../../content/maya-dialogue-graph'
import { devonDialogueNodes } from '../../content/devon-dialogue-graph'
import { jordanDialogueNodes } from '../../content/jordan-dialogue-graph'
import { tessDialogueNodes } from '../../content/tess-dialogue-graph'
import { graceDialogueNodes } from '../../content/grace-dialogue-graph'
import { alexDialogueNodes } from '../../content/alex-dialogue-graph'
import { silasDialogueNodes } from '../../content/silas-dialogue-graph'
import { yaquinDialogueNodes } from '../../content/yaquin-dialogue-graph'
import { elenaDialogueNodes } from '../../content/elena-dialogue-graph'
import { ashaDialogueNodes } from '../../content/asha-dialogue-graph'
import { liraDialogueNodes } from '../../content/lira-dialogue-graph'
import { zaraDialogueNodes } from '../../content/zara-dialogue-graph'

describe('Vulnerability Arcs', () => {
  describe('Vulnerability Trust Threshold', () => {
    test('vulnerability threshold should be at "trusted" level', () => {
      expect(VULNERABILITY_TRUST_THRESHOLD).toBe(6)
      expect(VULNERABILITY_TRUST_THRESHOLD).toBe(TRUST_THRESHOLDS.trusted)
    })

    test('vulnerability requires significant relationship investment', () => {
      // Vulnerability reveals should require at least 60% of max trust
      expect(VULNERABILITY_TRUST_THRESHOLD / 10).toBeGreaterThanOrEqual(0.6)
    })
  })

  describe('E2-062: Samuel\'s Vulnerability Arc', () => {
    test('should have vulnerability arc entry node', () => {
      const vulnerabilityNode = samuelDialogueNodes.find(
        node => node.nodeId === 'samuel_vulnerability_arc' ||
                node.nodeId.includes('samuel_vulnerability')
      )
      expect(vulnerabilityNode).toBeDefined()
    })

    test('vulnerability arc should be trust-gated', () => {
      const vulnerabilityNode = samuelDialogueNodes.find(
        node => node.nodeId === 'samuel_vulnerability_arc' ||
                node.nodeId.includes('samuel_vulnerability')
      )

      if (vulnerabilityNode?.requiredState) {
        expect(vulnerabilityNode.requiredState.trust?.min).toBeGreaterThanOrEqual(VULNERABILITY_TRUST_THRESHOLD)
      }
    })

    test('vulnerability arc should reveal backstory', () => {
      const vulnerabilityNode = samuelDialogueNodes.find(
        node => node.nodeId === 'samuel_vulnerability_arc' ||
                node.nodeId.includes('samuel_vulnerability')
      )

      if (vulnerabilityNode) {
        const content = vulnerabilityNode.content[0]?.text || ''
        // Should reveal what Samuel lost to become the Conductor
        expect(
          content.toLowerCase().includes('lost') ||
          content.toLowerCase().includes('sacrifice') ||
          content.toLowerCase().includes('gave up') ||
          content.toLowerCase().includes('left behind')
        ).toBe(true)
      }
    })
  })

  describe('E2-063: Marcus\'s Vulnerability Arc', () => {
    test('should have vulnerability arc entry node', () => {
      const vulnerabilityNode = marcusDialogueNodes.find(
        node => node.nodeId === 'marcus_vulnerability_arc' ||
                node.nodeId.includes('marcus_vulnerability')
      )
      expect(vulnerabilityNode).toBeDefined()
    })

    test('vulnerability arc should reference the breach', () => {
      const vulnerabilityNode = marcusDialogueNodes.find(
        node => node.nodeId === 'marcus_vulnerability_arc' ||
                node.nodeId.includes('marcus_vulnerability')
      )

      if (vulnerabilityNode) {
        const content = vulnerabilityNode.content[0]?.text || ''
        // Should reference the breach Marcus couldn't prevent
        expect(
          content.toLowerCase().includes('breach') ||
          content.toLowerCase().includes('failed') ||
          content.toLowerCase().includes('couldn\'t prevent') ||
          content.toLowerCase().includes('too late')
        ).toBe(true)
      }
    })
  })

  describe('E2-064: Kai\'s Vulnerability Arc', () => {
    test('should have vulnerability arc entry node', () => {
      const vulnerabilityNode = kaiDialogueNodes.find(
        node => node.nodeId === 'kai_vulnerability_arc' ||
                node.nodeId.includes('kai_vulnerability')
      )
      expect(vulnerabilityNode).toBeDefined()
    })

    test('vulnerability arc should reference failed inspection', () => {
      const vulnerabilityNode = kaiDialogueNodes.find(
        node => node.nodeId === 'kai_vulnerability_arc' ||
                node.nodeId.includes('kai_vulnerability')
      )

      if (vulnerabilityNode) {
        const content = vulnerabilityNode.content[0]?.text || ''
        // Should reference the project that failed inspection
        expect(
          content.toLowerCase().includes('inspection') ||
          content.toLowerCase().includes('failed') ||
          content.toLowerCase().includes('passed') ||
          content.toLowerCase().includes('approved')
        ).toBe(true)
      }
    })
  })

  describe('E2-065: Rohan\'s Vulnerability Arc', () => {
    test('should have vulnerability arc entry node', () => {
      const vulnerabilityNode = rohanDialogueNodes.find(
        node => node.nodeId === 'rohan_vulnerability_arc' ||
                node.nodeId.includes('rohan_vulnerability')
      )
      expect(vulnerabilityNode).toBeDefined()
    })

    test('vulnerability arc should reference truth and relationships', () => {
      const vulnerabilityNode = rohanDialogueNodes.find(
        node => node.nodeId === 'rohan_vulnerability_arc' ||
                node.nodeId.includes('rohan_vulnerability')
      )

      if (vulnerabilityNode) {
        const content = vulnerabilityNode.content[0]?.text || ''
        // Should reference the truth that cost him relationships
        expect(
          content.toLowerCase().includes('truth') ||
          content.toLowerCase().includes('relationship') ||
          content.toLowerCase().includes('friend') ||
          content.toLowerCase().includes('cost')
        ).toBe(true)
      }
    })
  })

  describe('Extended Coverage: Maya\'s Vulnerability Arc', () => {
    test('should have vulnerability arc entry node', () => {
      const vulnerabilityNode = mayaDialogueNodes.find(
        node => node.nodeId.includes('maya_vulnerability')
      )
      expect(vulnerabilityNode).toBeDefined()
    })

    test('vulnerability arc should reference family/pretending', () => {
      const vulnerabilityNode = mayaDialogueNodes.find(
        node => node.nodeId.includes('maya_vulnerability')
      )

      if (vulnerabilityNode) {
        const content = vulnerabilityNode.content[0]?.text || ''
        expect(
          content.toLowerCase().includes('pretend') ||
          content.toLowerCase().includes('daughter') ||
          content.toLowerCase().includes('parents') ||
          content.toLowerCase().includes('family')
        ).toBe(true)
      }
    })
  })

  describe('Extended Coverage: Devon\'s Vulnerability Arc', () => {
    test('should have vulnerability arc entry node', () => {
      const vulnerabilityNode = devonDialogueNodes.find(
        node => node.nodeId.includes('devon_vulnerability')
      )
      expect(vulnerabilityNode).toBeDefined()
    })

    test('vulnerability arc should reference father/mother', () => {
      const vulnerabilityNode = devonDialogueNodes.find(
        node => node.nodeId.includes('devon_vulnerability')
      )

      if (vulnerabilityNode) {
        const content = vulnerabilityNode.content[0]?.text || ''
        expect(
          content.toLowerCase().includes('dad') ||
          content.toLowerCase().includes('mom') ||
          content.toLowerCase().includes('mother') ||
          content.toLowerCase().includes('father')
        ).toBe(true)
      }
    })
  })

  describe('Extended Coverage: Jordan\'s Vulnerability Arc', () => {
    test('should have vulnerability arc entry node', () => {
      const vulnerabilityNode = jordanDialogueNodes.find(
        node => node.nodeId.includes('jordan_vulnerability')
      )
      expect(vulnerabilityNode).toBeDefined()
    })

    test('vulnerability arc should reference workplace/discovery', () => {
      const vulnerabilityNode = jordanDialogueNodes.find(
        node => node.nodeId.includes('jordan_vulnerability')
      )

      if (vulnerabilityNode) {
        const content = vulnerabilityNode.content[0]?.text || ''
        expect(
          content.toLowerCase().includes('slack') ||
          content.toLowerCase().includes('optics') ||
          content.toLowerCase().includes('job') ||
          content.toLowerCase().includes('broke')
        ).toBe(true)
      }
    })
  })

  describe('Extended Coverage: Tess\'s Vulnerability Arc', () => {
    test('should have vulnerability arc entry node', () => {
      const vulnerabilityNode = tessDialogueNodes.find(
        node => node.nodeId.includes('tess_vulnerability')
      )
      expect(vulnerabilityNode).toBeDefined()
    })

    test('vulnerability arc should reference partner/Elena', () => {
      const vulnerabilityNode = tessDialogueNodes.find(
        node => node.nodeId.includes('tess_vulnerability')
      )

      if (vulnerabilityNode) {
        const content = vulnerabilityNode.content[0]?.text || ''
        expect(
          content.toLowerCase().includes('elena') ||
          content.toLowerCase().includes('partner') ||
          content.toLowerCase().includes('alone') ||
          content.toLowerCase().includes('left')
        ).toBe(true)
      }
    })
  })

  describe('Extended Coverage: Grace\'s Vulnerability Arc', () => {
    test('should have vulnerability arc entry node', () => {
      const vulnerabilityNode = graceDialogueNodes.find(
        node => node.nodeId.includes('grace_vulnerability')
      )
      expect(vulnerabilityNode).toBeDefined()
    })

    test('vulnerability arc should reference quit/daughter', () => {
      const vulnerabilityNode = graceDialogueNodes.find(
        node => node.nodeId.includes('grace_vulnerability')
      )

      if (vulnerabilityNode) {
        const content = vulnerabilityNode.content[0]?.text || ''
        expect(
          content.toLowerCase().includes('quit') ||
          content.toLowerCase().includes('daughter') ||
          content.toLowerCase().includes('recital') ||
          content.toLowerCase().includes('almost')
        ).toBe(true)
      }
    })
  })

  describe('Extended Coverage: Alex\'s Vulnerability Arc', () => {
    test('should have vulnerability arc entry node', () => {
      const vulnerabilityNode = alexDialogueNodes.find(
        node => node.nodeId.includes('alex_vulnerability')
      )
      expect(vulnerabilityNode).toBeDefined()
    })

    test('vulnerability arc should reference student/selling hope', () => {
      const vulnerabilityNode = alexDialogueNodes.find(
        node => node.nodeId.includes('alex_vulnerability')
      )

      if (vulnerabilityNode) {
        const content = vulnerabilityNode.content[0]?.text || ''
        expect(
          content.toLowerCase().includes('student') ||
          content.toLowerCase().includes('maria') ||
          content.toLowerCase().includes('possible') ||
          content.toLowerCase().includes('selling')
        ).toBe(true)
      }
    })
  })

  describe('Extended Coverage: Silas\'s Vulnerability Arc', () => {
    test('should have vulnerability arc entry node', () => {
      const vulnerabilityNode = silasDialogueNodes.find(
        node => node.nodeId.includes('silas_vulnerability')
      )
      expect(vulnerabilityNode).toBeDefined()
    })

    test('vulnerability arc should reference Mr. Hawkins/regret', () => {
      const vulnerabilityNode = silasDialogueNodes.find(
        node => node.nodeId.includes('silas_vulnerability')
      )

      if (vulnerabilityNode) {
        const content = vulnerabilityNode.content[0]?.text || ''
        expect(
          content.toLowerCase().includes('hawkins') ||
          content.toLowerCase().includes('cancelled') ||
          content.toLowerCase().includes('thank you') ||
          content.toLowerCase().includes('died')
        ).toBe(true)
      }
    })
  })

  describe('Extended Coverage: Yaquin\'s Vulnerability Arc', () => {
    test('should have vulnerability arc entry node', () => {
      const vulnerabilityNode = yaquinDialogueNodes.find(
        node => node.nodeId.includes('yaquin_vulnerability')
      )
      expect(vulnerabilityNode).toBeDefined()
    })

    test('vulnerability arc should reference father/family expectations', () => {
      const vulnerabilityNode = yaquinDialogueNodes.find(
        node => node.nodeId.includes('yaquin_vulnerability')
      )

      if (vulnerabilityNode) {
        const content = vulnerabilityNode.content[0]?.text || ''
        expect(
          content.toLowerCase().includes('father') ||
          content.toLowerCase().includes('manila') ||
          content.toLowerCase().includes('siblings') ||
          content.toLowerCase().includes('waste')
        ).toBe(true)
      }
    })
  })

  describe('Extended Coverage: Elena\'s Vulnerability Arc', () => {
    test('should have vulnerability arc entry node', () => {
      const vulnerabilityNode = elenaDialogueNodes.find(
        node => node.nodeId.includes('elena_vulnerability')
      )
      expect(vulnerabilityNode).toBeDefined()
    })

    test('vulnerability arc should reference Station Seven tragedy', () => {
      const vulnerabilityNode = elenaDialogueNodes.find(
        node => node.nodeId.includes('elena_vulnerability')
      )

      if (vulnerabilityNode) {
        const content = vulnerabilityNode.content[0]?.text || ''
        expect(
          content.toLowerCase().includes('station seven') ||
          content.toLowerCase().includes('anomaly') ||
          content.toLowerCase().includes('drift') ||
          content.toLowerCase().includes('four people')
        ).toBe(true)
      }
    })
  })

  describe('Extended Coverage: Asha\'s Vulnerability Arc', () => {
    test('should have vulnerability arc entry node', () => {
      const vulnerabilityNode = ashaDialogueNodes.find(
        node => node.nodeId.includes('asha_vulnerability')
      )
      expect(vulnerabilityNode).toBeDefined()
    })

    test('vulnerability arc should reference painted over mural', () => {
      const vulnerabilityNode = ashaDialogueNodes.find(
        node => node.nodeId === 'asha_vulnerability_arc'
      )

      if (vulnerabilityNode) {
        const content = vulnerabilityNode.content[0]?.text || ''
        expect(
          content.toLowerCase().includes('painted over') ||
          content.toLowerCase().includes('city hall') ||
          content.toLowerCase().includes('too political') ||
          content.toLowerCase().includes('too diverse')
        ).toBe(true)
      }
    })
  })

  describe('Extended Coverage: Lira\'s Vulnerability Arc', () => {
    test('should have vulnerability arc entry node', () => {
      const vulnerabilityNode = liraDialogueNodes.find(
        node => node.nodeId.includes('lira_vulnerability')
      )
      expect(vulnerabilityNode).toBeDefined()
    })

    test('vulnerability arc should reference grandmother/memory loss', () => {
      const vulnerabilityNode = liraDialogueNodes.find(
        node => node.nodeId.includes('lira_vulnerability')
      )

      if (vulnerabilityNode) {
        const content = vulnerabilityNode.content[0]?.text || ''
        expect(
          content.toLowerCase().includes('grandmother') ||
          content.toLowerCase().includes('pianist') ||
          content.toLowerCase().includes('forgetting') ||
          content.toLowerCase().includes('chopin')
        ).toBe(true)
      }
    })
  })

  describe('Extended Coverage: Zara\'s Vulnerability Arc', () => {
    test('should have vulnerability arc entry node', () => {
      const vulnerabilityNode = zaraDialogueNodes.find(
        node => node.nodeId.includes('zara_vulnerability')
      )
      expect(vulnerabilityNode).toBeDefined()
    })

    test('vulnerability arc should reference triage algorithm harm', () => {
      const vulnerabilityNode = zaraDialogueNodes.find(
        node => node.nodeId.includes('zara_vulnerability')
      )

      if (vulnerabilityNode) {
        const content = vulnerabilityNode.content[0]?.text || ''
        expect(
          content.toLowerCase().includes('triage') ||
          content.toLowerCase().includes('hospital') ||
          content.toLowerCase().includes('fourteen') ||
          content.toLowerCase().includes('deployment')
        ).toBe(true)
      }
    })
  })

  describe('Vulnerability Arc Structure', () => {
    const checkVulnerabilityArcStructure = (nodes: DialogueNode[], characterName: string) => {
      const vulnerabilityNode = nodes.find(
        node => node.nodeId.includes(`${characterName.toLowerCase()}_vulnerability`)
      )

      if (!vulnerabilityNode) {
        return { exists: false }
      }

      return {
        exists: true,
        hasTrustGate: vulnerabilityNode.requiredState?.trust?.min !== undefined,
        hasEmotionalContent: vulnerabilityNode.content[0]?.emotion !== undefined,
        hasChoices: vulnerabilityNode.choices.length > 0,
        setsKnowledgeFlags: vulnerabilityNode.onEnter?.some(
          action => action.addKnowledgeFlags && action.addKnowledgeFlags.length > 0
        ) || vulnerabilityNode.choices.some(
          choice => choice.consequence?.addKnowledgeFlags && choice.consequence.addKnowledgeFlags.length > 0
        )
      }
    }

    test('Samuel vulnerability arc should have proper structure', () => {
      const result = checkVulnerabilityArcStructure(samuelDialogueNodes, 'samuel')
      expect(result.exists).toBe(true)
      if (result.exists) {
        expect(result.hasEmotionalContent).toBe(true)
        expect(result.hasChoices).toBe(true)
      }
    })

    test('Marcus vulnerability arc should have proper structure', () => {
      const result = checkVulnerabilityArcStructure(marcusDialogueNodes, 'marcus')
      expect(result.exists).toBe(true)
      if (result.exists) {
        expect(result.hasEmotionalContent).toBe(true)
        expect(result.hasChoices).toBe(true)
      }
    })

    test('Kai vulnerability arc should have proper structure', () => {
      const result = checkVulnerabilityArcStructure(kaiDialogueNodes, 'kai')
      expect(result.exists).toBe(true)
      if (result.exists) {
        expect(result.hasEmotionalContent).toBe(true)
        expect(result.hasChoices).toBe(true)
      }
    })

    test('Rohan vulnerability arc should have proper structure', () => {
      const result = checkVulnerabilityArcStructure(rohanDialogueNodes, 'rohan')
      expect(result.exists).toBe(true)
      if (result.exists) {
        expect(result.hasEmotionalContent).toBe(true)
        expect(result.hasChoices).toBe(true)
      }
    })

    test('Maya vulnerability arc should have proper structure', () => {
      const result = checkVulnerabilityArcStructure(mayaDialogueNodes, 'maya')
      expect(result.exists).toBe(true)
      if (result.exists) {
        expect(result.hasEmotionalContent).toBe(true)
        expect(result.hasChoices).toBe(true)
      }
    })

    test('Devon vulnerability arc should have proper structure', () => {
      const result = checkVulnerabilityArcStructure(devonDialogueNodes, 'devon')
      expect(result.exists).toBe(true)
      if (result.exists) {
        expect(result.hasEmotionalContent).toBe(true)
        expect(result.hasChoices).toBe(true)
      }
    })

    test('Jordan vulnerability arc should have proper structure', () => {
      const result = checkVulnerabilityArcStructure(jordanDialogueNodes, 'jordan')
      expect(result.exists).toBe(true)
      if (result.exists) {
        expect(result.hasEmotionalContent).toBe(true)
        expect(result.hasChoices).toBe(true)
      }
    })

    test('Tess vulnerability arc should have proper structure', () => {
      const result = checkVulnerabilityArcStructure(tessDialogueNodes, 'tess')
      expect(result.exists).toBe(true)
      if (result.exists) {
        expect(result.hasEmotionalContent).toBe(true)
        expect(result.hasChoices).toBe(true)
      }
    })

    test('Grace vulnerability arc should have proper structure', () => {
      const result = checkVulnerabilityArcStructure(graceDialogueNodes, 'grace')
      expect(result.exists).toBe(true)
      if (result.exists) {
        expect(result.hasEmotionalContent).toBe(true)
        expect(result.hasChoices).toBe(true)
      }
    })

    test('Alex vulnerability arc should have proper structure', () => {
      const result = checkVulnerabilityArcStructure(alexDialogueNodes, 'alex')
      expect(result.exists).toBe(true)
      if (result.exists) {
        expect(result.hasEmotionalContent).toBe(true)
        expect(result.hasChoices).toBe(true)
      }
    })

    test('Silas vulnerability arc should have proper structure', () => {
      const result = checkVulnerabilityArcStructure(silasDialogueNodes, 'silas')
      expect(result.exists).toBe(true)
      if (result.exists) {
        expect(result.hasEmotionalContent).toBe(true)
        expect(result.hasChoices).toBe(true)
      }
    })

    test('Yaquin vulnerability arc should have proper structure', () => {
      const result = checkVulnerabilityArcStructure(yaquinDialogueNodes, 'yaquin')
      expect(result.exists).toBe(true)
      if (result.exists) {
        expect(result.hasEmotionalContent).toBe(true)
        expect(result.hasChoices).toBe(true)
      }
    })

    test('Elena vulnerability arc should have proper structure', () => {
      const result = checkVulnerabilityArcStructure(elenaDialogueNodes, 'elena')
      expect(result.exists).toBe(true)
      if (result.exists) {
        expect(result.hasEmotionalContent).toBe(true)
        expect(result.hasChoices).toBe(true)
      }
    })

    test('Asha vulnerability arc should have proper structure', () => {
      const result = checkVulnerabilityArcStructure(ashaDialogueNodes, 'asha')
      expect(result.exists).toBe(true)
      if (result.exists) {
        expect(result.hasEmotionalContent).toBe(true)
        expect(result.hasChoices).toBe(true)
      }
    })

    test('Lira vulnerability arc should have proper structure', () => {
      const result = checkVulnerabilityArcStructure(liraDialogueNodes, 'lira')
      expect(result.exists).toBe(true)
      if (result.exists) {
        expect(result.hasEmotionalContent).toBe(true)
        expect(result.hasChoices).toBe(true)
      }
    })

    test('Zara vulnerability arc should have proper structure', () => {
      const result = checkVulnerabilityArcStructure(zaraDialogueNodes, 'zara')
      expect(result.exists).toBe(true)
      if (result.exists) {
        expect(result.hasEmotionalContent).toBe(true)
        expect(result.hasChoices).toBe(true)
      }
    })
  })

  describe('Vulnerability Knowledge Flags', () => {
    test('should define vulnerability-related knowledge flags', () => {
      // Verify the pattern exists in at least one character
      const allNodes = [
        ...samuelDialogueNodes,
        ...marcusDialogueNodes,
        ...kaiDialogueNodes,
        ...rohanDialogueNodes,
        ...mayaDialogueNodes,
        ...devonDialogueNodes,
        ...jordanDialogueNodes,
        ...tessDialogueNodes,
        ...graceDialogueNodes,
        ...alexDialogueNodes,
        ...silasDialogueNodes,
        ...yaquinDialogueNodes,
        ...elenaDialogueNodes,
        ...ashaDialogueNodes,
        ...liraDialogueNodes,
        ...zaraDialogueNodes
      ]

      const vulnerabilityFlags = allNodes.flatMap(node => {
        const flags: string[] = []
        node.onEnter?.forEach(action => {
          if (action.addKnowledgeFlags) {
            flags.push(...action.addKnowledgeFlags.filter(f =>
              f.includes('vulnerability') || f.includes('backstory') || f.includes('revealed')
            ))
          }
        })
        node.choices.forEach(choice => {
          if (choice.consequence?.addKnowledgeFlags) {
            flags.push(...choice.consequence.addKnowledgeFlags.filter(f =>
              f.includes('vulnerability') || f.includes('backstory') || f.includes('revealed')
            ))
          }
        })
        return flags
      })

      expect(vulnerabilityFlags.length).toBeGreaterThan(0)
    })
  })
})
